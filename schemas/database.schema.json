{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Template Doctor Database Schema",
    "description": "MongoDB collections schema for Template Doctor application",
    "definitions": {
        "ruleSet": {
            "type": "string",
            "enum": ["dod", "partner", "docs", "custom"],
            "description": "Valid ruleset types. NEVER use 'azd' - that's a deployment test, not a ruleset."
        },
        "azdTestStatus": {
            "type": "string",
            "enum": ["pending", "running", "success", "failed"],
            "description": "Azure Developer CLI deployment test status"
        },
        "analysisDocument": {
            "type": "object",
            "required": [
                "_id",
                "repoUrl",
                "ruleSet",
                "timestamp",
                "compliance",
                "createdAt",
                "updatedAt"
            ],
            "properties": {
                "_id": {
                    "type": "string",
                    "description": "MongoDB ObjectId"
                },
                "repoUrl": {
                    "type": "string",
                    "format": "uri",
                    "description": "Full repository URL"
                },
                "ruleSet": {
                    "$ref": "#/definitions/ruleSet"
                },
                "timestamp": {
                    "type": "string",
                    "format": "date-time",
                    "description": "When analysis was performed"
                },
                "scanDate": {
                    "type": "string",
                    "format": "date-time",
                    "description": "Scan date (may differ from timestamp)"
                },
                "compliance": {
                    "type": "object",
                    "required": ["percentage", "issues", "passed"],
                    "properties": {
                        "percentage": {
                            "type": "number",
                            "minimum": 0,
                            "maximum": 100
                        },
                        "issues": {
                            "type": "number",
                            "minimum": 0
                        },
                        "passed": {
                            "type": "number",
                            "minimum": 0
                        }
                    }
                },
                "categories": {
                    "type": "object",
                    "description": "Categorized compliance results"
                },
                "issues": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "required": ["id", "severity", "message"],
                        "properties": {
                            "id": { "type": "string" },
                            "severity": {
                                "type": "string",
                                "enum": ["info", "warning", "error"]
                            },
                            "message": { "type": "string" },
                            "error": { "type": "string" },
                            "category": { "type": "string" }
                        }
                    }
                },
                "compliant": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "required": ["id", "category", "message"],
                        "properties": {
                            "id": { "type": "string" },
                            "category": { "type": "string" },
                            "message": { "type": "string" },
                            "details": { "type": "object" }
                        }
                    }
                },
                "analysisResult": {
                    "type": "object",
                    "description": "Full analyzer output"
                },
                "createdBy": {
                    "type": "string",
                    "description": "GitHub username who triggered analysis"
                },
                "scannedBy": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "List of users who scanned this repo"
                },
                "upstreamTemplate": {
                    "type": "string",
                    "description": "Original template URL if forked"
                },
                "archiveRequested": {
                    "type": "boolean",
                    "description": "Whether template was archived"
                },
                "createdAt": {
                    "type": "string",
                    "format": "date-time"
                },
                "updatedAt": {
                    "type": "string",
                    "format": "date-time"
                }
            }
        },
        "repoDocument": {
            "type": "object",
            "required": [
                "_id",
                "repoUrl",
                "owner",
                "repo",
                "createdAt",
                "updatedAt"
            ],
            "properties": {
                "_id": {
                    "type": "string",
                    "description": "MongoDB ObjectId"
                },
                "repoUrl": {
                    "type": "string",
                    "format": "uri",
                    "description": "Full repository URL (unique key)"
                },
                "owner": {
                    "type": "string",
                    "description": "GitHub repository owner"
                },
                "repo": {
                    "type": "string",
                    "description": "GitHub repository name"
                },
                "latestAnalysis": {
                    "type": "object",
                    "description": "Denormalized latest analysis summary",
                    "required": [
                        "scanDate",
                        "ruleSet",
                        "compliancePercentage",
                        "passed",
                        "issues",
                        "analysisId"
                    ],
                    "properties": {
                        "scanDate": {
                            "type": "string",
                            "format": "date-time"
                        },
                        "ruleSet": {
                            "$ref": "#/definitions/ruleSet"
                        },
                        "compliancePercentage": {
                            "type": "number",
                            "minimum": 0,
                            "maximum": 100
                        },
                        "passed": {
                            "type": "number",
                            "minimum": 0
                        },
                        "issues": {
                            "type": "number",
                            "minimum": 0
                        },
                        "analysisId": {
                            "type": "string",
                            "description": "ObjectId reference to full analysis document"
                        }
                    }
                },
                "latestAzdTest": {
                    "type": "object",
                    "description": "Latest Azure Developer CLI deployment test result (NOT a ruleset!)",
                    "required": ["testId", "timestamp", "status"],
                    "properties": {
                        "testId": {
                            "type": "string",
                            "description": "Unique test identifier"
                        },
                        "timestamp": {
                            "type": "string",
                            "format": "date-time"
                        },
                        "status": {
                            "$ref": "#/definitions/azdTestStatus"
                        },
                        "duration": {
                            "type": "number",
                            "description": "Test duration in milliseconds"
                        },
                        "result": {
                            "type": "object",
                            "properties": {
                                "deploymentTime": {
                                    "type": "number",
                                    "description": "Time to deploy in milliseconds"
                                },
                                "resourcesCreated": {
                                    "type": "number",
                                    "description": "Number of Azure resources created"
                                },
                                "azdUpSuccess": {
                                    "type": "boolean",
                                    "description": "Whether 'azd up' succeeded"
                                },
                                "azdDownSuccess": {
                                    "type": "boolean",
                                    "description": "Whether 'azd down' succeeded"
                                },
                                "errors": {
                                    "type": "array",
                                    "items": { "type": "string" }
                                },
                                "warnings": {
                                    "type": "array",
                                    "items": { "type": "string" }
                                },
                                "endpoints": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "required": ["name", "url"],
                                        "properties": {
                                            "name": { "type": "string" },
                                            "url": {
                                                "type": "string",
                                                "format": "uri"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                "upstreamTemplate": {
                    "type": "string",
                    "description": "Original template if forked"
                },
                "archiveRequested": {
                    "type": "boolean"
                },
                "tags": {
                    "type": "array",
                    "items": { "type": "string" }
                },
                "createdAt": {
                    "type": "string",
                    "format": "date-time"
                },
                "updatedAt": {
                    "type": "string",
                    "format": "date-time"
                }
            }
        },
        "azdTestDocument": {
            "type": "object",
            "required": [
                "_id",
                "repoUrl",
                "status",
                "startedAt",
                "createdAt",
                "updatedAt"
            ],
            "properties": {
                "_id": {
                    "type": "string",
                    "description": "MongoDB ObjectId"
                },
                "repoUrl": {
                    "type": "string",
                    "format": "uri"
                },
                "status": {
                    "$ref": "#/definitions/azdTestStatus"
                },
                "startedAt": {
                    "type": "string",
                    "format": "date-time"
                },
                "completedAt": {
                    "type": "string",
                    "format": "date-time"
                },
                "duration": {
                    "type": "number",
                    "description": "milliseconds"
                },
                "trigger": {
                    "type": "object",
                    "properties": {
                        "type": {
                            "type": "string",
                            "enum": ["manual", "webhook", "scheduled"]
                        },
                        "user": { "type": "string" },
                        "analysisId": { "type": "string" }
                    }
                },
                "result": {
                    "type": "object",
                    "description": "Same as latestAzdTest.result in repos collection"
                },
                "logs": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "timestamp": {
                                "type": "string",
                                "format": "date-time"
                            },
                            "level": {
                                "type": "string",
                                "enum": ["info", "warning", "error"]
                            },
                            "message": { "type": "string" }
                        }
                    }
                },
                "createdAt": {
                    "type": "string",
                    "format": "date-time"
                },
                "updatedAt": {
                    "type": "string",
                    "format": "date-time"
                }
            }
        }
    },
    "properties": {
        "collections": {
            "type": "object",
            "properties": {
                "analysis": {
                    "type": "array",
                    "description": "Analysis results collection",
                    "items": {
                        "$ref": "#/definitions/analysisDocument"
                    }
                },
                "repos": {
                    "type": "array",
                    "description": "Repository metadata collection",
                    "items": {
                        "$ref": "#/definitions/repoDocument"
                    }
                },
                "azdtests": {
                    "type": "array",
                    "description": "Azure Developer CLI deployment test results",
                    "items": {
                        "$ref": "#/definitions/azdTestDocument"
                    }
                }
            }
        }
    }
}
