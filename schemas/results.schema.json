{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Template Doctor Analysis Result",
    "type": "object",
    "required": ["repoUrl", "timestamp", "compliance"],
    "properties": {
        "collection": {
            "type": "string",
            "description": "Collection identifier in the format collection:[name]"
        },
        "repoUrl": {
            "type": "string",
            "format": "uri",
            "description": "The full URL of the analyzed repository"
        },
        "azdValidation": {
            "type": ["object", "null"],
            "description": "Azure Developer CLI (azd) validation results from artifact parsing",
            "required": [
                "azdUpSuccess",
                "azdDownSuccess",
                "psRuleErrors",
                "psRuleWarnings",
                "securityStatus",
                "overallStatus",
                "resultFileContent"
            ],
            "properties": {
                "azdUpSuccess": {
                    "type": "boolean",
                    "description": "Whether 'azd up' succeeded"
                },
                "azdUpTime": {
                    "type": ["string", "null"],
                    "description": "Execution time for 'azd up' (e.g., '45.2s')",
                    "pattern": "^\\d+(\\.\\d+)?s$"
                },
                "azdDownSuccess": {
                    "type": "boolean",
                    "description": "Whether 'azd down' succeeded"
                },
                "azdDownTime": {
                    "type": ["string", "null"],
                    "description": "Execution time for 'azd down' (e.g., '30.1s')",
                    "pattern": "^\\d+(\\.\\d+)?s$"
                },
                "psRuleErrors": {
                    "type": "number",
                    "minimum": 0,
                    "description": "Number of PSRule security errors found"
                },
                "psRuleWarnings": {
                    "type": "number",
                    "minimum": 0,
                    "description": "Number of PSRule security warnings found"
                },
                "securityStatus": {
                    "type": "string",
                    "enum": ["pass", "warnings", "errors"],
                    "description": "Overall security scan status"
                },
                "overallStatus": {
                    "type": "string",
                    "enum": ["success", "warning", "failure"],
                    "description": "Overall validation status (success: all pass, warning: has warnings, failure: has errors or azd failures)"
                },
                "resultFileContent": {
                    "type": "string",
                    "description": "Full markdown content from the validation artifact result file"
                }
            },
            "additionalProperties": false
        },
        "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp of when the analysis was run"
        },
        "compliance": {
            "type": "object",
            "required": ["issues", "summary"],
            "properties": {
                "summary": {
                    "type": "string",
                    "description": "Overall compliance summary"
                },
                "issues": {
                    "type": "array",
                    "description": "List of issues found (legacy flat list for backward compatibility)",
                    "items": {
                        "type": "object",
                        "required": ["id", "severity", "message"],
                        "properties": {
                            "id": {
                                "type": "string",
                                "description": "Unique identifier for the issue"
                            },
                            "severity": {
                                "type": "string",
                                "enum": ["info", "warning", "error"],
                                "description": "Severity level of the issue"
                            },
                            "message": {
                                "type": "string",
                                "description": "Human-readable description of the issue"
                            },
                            "error": {
                                "type": "string",
                                "description": "Optional error message if the issue was due to an error reading a file"
                            }
                        }
                    }
                },
                "percentage": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Overall compliance percentage (legacy numeric field for backward compatibility)"
                },
                "compliant": {
                    "type": "array",
                    "description": "List of passed checks (legacy flat list for backward compatibility)",
                    "items": {
                        "type": "object",
                        "required": ["id", "message"],
                        "properties": {
                            "id": { "type": "string" },
                            "message": { "type": "string" },
                            "category": { "type": "string" },
                            "details": { "type": ["object", "null"] }
                        }
                    }
                },
                "categories": {
                    "type": "object",
                    "description": "Categorized compliance breakdown",
                    "properties": {
                        "repositoryManagement": {
                            "$ref": "#/definitions/categoryCompliance"
                        },
                        "functionalRequirements": {
                            "$ref": "#/definitions/categoryCompliance"
                        },
                        "deployment": {
                            "$ref": "#/definitions/categoryCompliance"
                        },
                        "security": {
                            "$ref": "#/definitions/categoryCompliance"
                        },
                        "testing": {
                            "$ref": "#/definitions/categoryCompliance"
                        },
                        "ai": { "$ref": "#/definitions/categoryCompliance" }
                    },
                    "additionalProperties": false
                },
                "globalChecks": {
                    "type": "array",
                    "description": "Optional list of global checks executed regardless of category selection (e.g., AI model deprecation)",
                    "items": {
                        "type": "object",
                        "required": ["id", "status"],
                        "properties": {
                            "id": { "type": "string" },
                            "status": {
                                "type": "string",
                                "enum": ["passed", "failed", "skipped"]
                            },
                            "details": { "type": ["object", "null"] }
                        }
                    }
                }
            },
            "additionalProperties": true
        }
    },
    "definitions": {
        "categoryCompliance": {
            "type": "object",
            "required": [
                "enabled",
                "issues",
                "compliant",
                "summary",
                "percentage"
            ],
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "description": "Whether this category of checks was enabled for the analysis run"
                },
                "summary": {
                    "type": "string",
                    "description": "Category compliance summary"
                },
                "percentage": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Percentage of passed checks in this category"
                },
                "issues": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "required": ["id", "severity", "message"],
                        "properties": {
                            "id": { "type": "string" },
                            "severity": {
                                "type": "string",
                                "enum": ["info", "warning", "error"]
                            },
                            "message": { "type": "string" },
                            "error": { "type": ["string", "null"] }
                        }
                    }
                },
                "compliant": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "required": ["id", "message"],
                        "properties": {
                            "id": { "type": "string" },
                            "message": { "type": "string" },
                            "category": { "type": "string" },
                            "details": { "type": ["object", "null"] }
                        }
                    }
                }
            },
            "additionalProperties": false
        }
    }
}
