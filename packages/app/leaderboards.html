<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Doctor - Leaderboards</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: #f8fafc;
            color: #64748b;
            border-bottom: 1px solid #e2e8f0;
            backdrop-filter: blur(10px);
            padding: 20px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            color: #1e293b;
        }

        .header p {
            margin: 8px 0 0;
            color: #64748b;
            font-size: 1rem;
        }

        .nav-toggle {
            display: none;
            background: none;
            border: none;
            color: #64748b;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: #1e293b;
        }

        .logo img {
            width: 40px;
            height: 40px;
        }

        .logo h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: #64748b;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links a:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .nav-links a.active {
            background: #f1f5f9;
            color: #1e293b;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .nav-toggle {
                display: block;
            }

            .nav-links {
                position: absolute;
                top: 100%;
                right: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                flex-direction: column;
                gap: 0;
                min-width: 200px;
                display: none;
            }

            .nav-links.open {
                display: flex;
            }

            .nav-links a {
                border-radius: 0;
                padding: 12px 20px;
            }

            .nav-links a:first-child {
                border-radius: 8px 8px 0 0;
            }

            .nav-links a:last-child {
                border-radius: 0 0 8px 8px;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .dashboard-title {
            text-align: center;
            color: #1e293b;
            margin-bottom: 40px;
        }

        .dashboard-title h1 {
            font-size: 48px;
            margin: 0 0 10px 0;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-title p {
            font-size: 18px;
            color: #64748b;
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-title .icon {
            font-size: 20px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rank-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .rank-1 { background: #ffd700; color: #8b5a00; }
        .rank-2 { background: #c0c0c0; color: #4a4a4a; }
        .rank-3 { background: #cd7f32; color: #fff; }
        .rank-other { background: #e2e8f0; color: #64748b; }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #1e293b;
        }

        .user-details {
            font-size: 12px;
            color: #64748b;
        }

        .score {
            font-weight: 700;
            color: #3b82f6;
            font-size: 18px;
        }

        .issue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .issue-item:last-child {
            border-bottom: none;
        }

        .issue-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .severity-high { background: #fee2e2; color: #dc2626; }
        .severity-medium { background: #fef3c7; color: #d97706; }
        .severity-low { background: #dcfce7; color: #16a34a; }

        .template-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .template-item:last-child {
            border-bottom: none;
        }

        .template-name {
            font-weight: 500;
            color: #1e293b;
        }

        .template-author {
            font-size: 12px;
            color: #64748b;
        }

        .health-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .health-bar {
            width: 60px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            border-radius: 3px;
        }

        .health-high { background: #16a34a; }
        .health-medium { background: #d97706; }
        .health-low { background: #dc2626; }

        .language-tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .model-tag {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .tech-usage-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .tech-usage-item:last-child {
            border-bottom: none;
        }

        .tech-info {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 150px;
        }

        .tech-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .tech-details {
            display: flex;
            flex-direction: column;
        }

        .tech-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .tech-percentage {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .tech-bar-container {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-left: 20px;
            overflow: hidden;
        }

        .tech-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease-in-out;
        }

        .chart-viz {
            min-height: 200px;
            margin-top: 16px;
        }

        .global-stats-section {
            margin-top: 60px;
            padding: 40px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            text-align: center;
        }

        .stats-section-title {
            color: white;
            font-size: 36px;
            font-weight: 700;
            margin: 0 0 40px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .big-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .big-stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .big-stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .big-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
        }

        .big-stat-number {
            font-size: 64px;
            font-weight: 900;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            line-height: 1;
        }

        .big-stat-label {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            line-height: 1.3;
        }

        .big-stat-icon {
            font-size: 48px;
            position: absolute;
            top: 20px;
            right: 20px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-title h1 {
                font-size: 32px;
            }

            .big-stats-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .big-stat-number {
                font-size: 48px;
            }

            .stats-section-title {
                font-size: 28px;
            }

            .global-stats-section {
                margin-top: 40px;
                padding: 30px 20px;
            }
        }

        /* Toggle Switch Styles */
        .data-source-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
        }

        .toggle-label.active {
            color: #1e293b;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: #cbd5e1;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #3b82f6;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .demo-banner {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            padding: 12px 0;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .demo-banner.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <img src="assets/images/templatedoctor.svg" alt="Template Doctor">
                <h1>Template Doctor</h1>
            </a>
            <button class="nav-toggle" onclick="toggleNav()" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="nav-links" id="main-nav">
                <a href="/"><i class="fas fa-home"></i> Dashboard</a>
                <a href="/leaderboards" class="active"><i class="fas fa-trophy"></i> Leaderboards</a>
                <a href="/setup"><i class="fas fa-cog"></i> Setup</a>
            </nav>
        </div>
    </header>

    <!-- Data Source Toggle -->
    <div class="data-source-toggle">
        <span class="toggle-label" id="demo-label">Demo Data</span>
        <div class="toggle-switch" id="data-toggle" onclick="toggleDataSource()">
            <div class="toggle-slider"></div>
        </div>
        <span class="toggle-label active" id="live-label">Live Database</span>
    </div>

    <!-- Demo Data Banner -->
    <div class="demo-banner hidden" id="demo-banner">
        <i class="fas fa-info-circle"></i>
        <strong>Demo Mode:</strong> Showing sample data for all sections.
        <span style="margin-left: 10px; font-size: 0.9em; opacity: 0.9;">Toggle to "Live Database" to see real data from your analyzed templates (3 sections available: Most Issues, Prevalent Issues, Active Templates).</span>
    </div>

    <div class="container">
        <div class="dashboard-title">
            <h1>🏆 Leaderboards</h1>
            <p>Community insights and top performers across all collections</p>
        </div>

        <div class="stats-grid">
            <!-- Top Analyzers Overall -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">👑</span>
                    Top Analyzers (Overall)
                </h2>
                <div id="top-analyzers-overall"></div>
            </div>

            <!-- Top Analyzers for aigallery -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">🎯</span>
                    Top Analyzers (aigallery)
                </h2>
                <div id="top-analyzers-aigallery"></div>
            </div>

            <!-- Most Successful Template Builders -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">🛠️</span>
                    Most Successful Builders
                </h2>
                <div id="successful-builders"></div>
            </div>

            <!-- Templates with Most Issues -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">⚠️</span>
                    Templates with Most Issues
                </h2>
                <div id="most-issues"></div>
            </div>

            <!-- Most Prevalent Issues -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">📊</span>
                    Most Prevalent Issues
                </h2>
                <div id="prevalent-issues" class="chart-viz"></div>
            </div>

            <!-- Most Active Templates -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">🔥</span>
                    Most Active Templates
                </h2>
                <div id="active-templates"></div>
            </div>

            <!-- Healthiest Templates by Language -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">💚</span>
                    Healthiest Templates (Python)
                </h2>
                <div id="healthy-python"></div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">💛</span>
                    Healthiest Templates (JavaScript)
                </h2>
                <div id="healthy-js"></div>
            </div>

            <!-- Most Successful Model -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">🤖</span>
                    Most Successful Models
                </h2>
                <div id="successful-models" class="chart-viz"></div>
            </div>

            <!-- Model/Language Success in Healthy Templates -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">🎯</span>
                    Model/Language Success (Healthy Templates)
                </h2>
                <div id="model-language-success" class="chart-viz"></div>
            </div>

            <!-- Most Successfully Deployed AZD Templates -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">🚀</span>
                    Most Successfully Deployed (AZD)
                </h2>
                <div id="successful-azd-deployments"></div>
            </div>

            <!-- Other MSFT Tech Usage -->
            <div class="chart-container">
                <h2 class="chart-title">
                    <span class="icon">🔧</span>
                    Other MSFT Tech Used by Templates
                </h2>
                <div id="msft-tech-usage"></div>
            </div>
        </div>

        <!-- Global Statistics -->
        <div class="global-stats-section">
            <h2 class="stats-section-title">🌍 Global Impact</h2>
            <div class="big-stats-grid">
                <div class="big-stat-card">
                    <div class="big-stat-number" id="templates-mcp">200</div>
                    <div class="big-stat-label">Templates Created with Template Kit MCP</div>
                    <div class="big-stat-icon">🛠️</div>
                </div>
                <div class="big-stat-card">
                    <div class="big-stat-number" id="total-installs">18</div>
                    <div class="big-stat-label">Total Installs of Template Doctor Across Microsoft</div>
                    <div class="big-stat-icon">📈</div>
                </div>
                <div class="big-stat-card">
                    <div class="big-stat-number" id="templates-analyzed">5,000</div>
                    <div class="big-stat-label">Total Templates Analyzed Until Now</div>
                    <div class="big-stat-icon">🔍</div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Check authentication - redirect to home if not logged in
        (function checkAuth() {
            const token = localStorage.getItem('gh_access_token');
            if (!token) {
                console.log('Not authenticated, redirecting to home page');
                window.location.href = '/';
                return;
            }
        })();

        // Data source state
        let useDemoData = localStorage.getItem('leaderboards-use-demo') === 'true';

        // Toggle data source
        function toggleDataSource() {
            useDemoData = !useDemoData;
            localStorage.setItem('leaderboards-use-demo', useDemoData);
            
            const toggle = document.getElementById('data-toggle');
            const banner = document.getElementById('demo-banner');
            const demoLabel = document.getElementById('demo-label');
            const liveLabel = document.getElementById('live-label');
            
            if (useDemoData) {
                toggle.classList.remove('active');
                banner.classList.remove('hidden');
                demoLabel.classList.add('active');
                liveLabel.classList.remove('active');
            } else {
                toggle.classList.add('active');
                banner.classList.add('hidden');
                demoLabel.classList.remove('active');
                liveLabel.classList.add('active');
            }
            
            // Reload data
            loadLeaderboards();
        }

        // Initialize toggle state
        (function initToggle() {
            const toggle = document.getElementById('data-toggle');
            const banner = document.getElementById('demo-banner');
            const demoLabel = document.getElementById('demo-label');
            const liveLabel = document.getElementById('live-label');
            
            if (useDemoData) {
                toggle.classList.remove('active');
                banner.classList.remove('hidden');
                demoLabel.classList.add('active');
                liveLabel.classList.remove('active');
            } else {
                toggle.classList.add('active');
                banner.classList.add('hidden');
                demoLabel.classList.remove('active');
                liveLabel.classList.add('active');
            }
        })();

        // Demo data (will be loaded from JSON)
        let demoData = null;
        
        // Load demo data from JSON file
        async function loadDemoData() {
            try {
                const response = await fetch('/data/leaderboards-demo.json');
                if (!response.ok) {
                    console.error('Failed to load demo data');
                    return null;
                }
                demoData = await response.json();
                console.log('📊 Demo data loaded from JSON');
                return demoData;
            } catch (error) {
                console.error('Error loading demo data:', error);
                return null;
            }
        }

        // Helper to show placeholder when no data
        function showPlaceholder(containerId, message = 'No data available yet. Run analysis on templates to see live data.') {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #64748b;">
                        <i class="fas fa-database" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                        <p style="margin: 0; font-size: 14px;">${message}</p>
                    </div>
                `;
            }
        }

        // Render functions
        function renderLeaderboard(containerId, items, scoreKey, detailsKey) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                showPlaceholder(containerId);
                return;
            }
            container.innerHTML = items.map((item, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                // Safely handle undefined scores
                const scoreValue = item[scoreKey] !== undefined && item[scoreKey] !== null ? item[scoreKey] : 0;
                const detailsValue = item[detailsKey] !== undefined ? item[detailsKey] : '';
                return `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">
                            <div class="rank-number ${rankClass}">${index + 1}</div>
                            <div class="user-info">
                                <div class="user-name">${item.avatar || ''} ${item.name || 'Unknown'}</div>
                                <div class="user-details">${detailsValue}</div>
                            </div>
                        </div>
                        <div class="score">${scoreValue}</div>
                    </div>
                `;
            }).join('');
        }

        function renderIssuesList(containerId, items) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                showPlaceholder(containerId);
                return;
            }
            container.innerHTML = items.map((item, index) => `
                <div class="issue-item">
                    <div>
                        <div class="template-name">${item.name}</div>
                        <div class="template-author">by ${item.author}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="issue-severity severity-${item.severity}">${item.severity}</span>
                        <span class="score">${item.issues}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderTemplatesList(containerId, items, showHealth = false) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                showPlaceholder(containerId);
                return;
            }
            container.innerHTML = items.map((item, index) => {
                const healthClass = item.health >= 90 ? 'health-high' : item.health >= 70 ? 'health-medium' : 'health-low';
                return `
                    <div class="template-item">
                        <div>
                            <div class="template-name">${item.name}</div>
                            <div class="template-author">by ${item.author}</div>
                        </div>
                        <div class="health-score">
                            ${showHealth ? `
                                <div class="health-bar">
                                    <div class="health-fill ${healthClass}" style="width: ${item.health}%"></div>
                                </div>
                                <span>${item.health}%</span>
                            ` : `
                                <span class="score">${item.activity || item.stars || item.downloads}</span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAzdDeploymentsList(containerId, items) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                showPlaceholder(containerId);
                return;
            }
            container.innerHTML = items.map((item, index) => {
                const serviceColors = {
                    'ACA': { bg: '#e0f2fe', color: '#0277bd' },
                    'AKS': { bg: '#f3e5f5', color: '#7b1fa2' },
                    'AF': { bg: '#e8f5e8', color: '#2e7d32' }
                };
                const serviceColor = serviceColors[item.service] || { bg: '#f5f5f5', color: '#424242' };
                
                return `
                    <div class="template-item">
                        <div>
                            <div class="template-name">${item.name}</div>
                            <div class="template-author">by ${item.author}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="service-tag" style="background: ${serviceColor.bg}; color: ${serviceColor.color}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${item.service}</span>
                            <div style="text-align: right;">
                                <div class="score">${item.deployments}</div>
                                <div style="font-size: 12px; color: #64748b;">${item.successRate}% success</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMsftTechUsage(containerId, items) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                showPlaceholder(containerId);
                return;
            }
            container.innerHTML = items.map((item, index) => {
                return `
                    <div class="tech-usage-item">
                        <div class="tech-info">
                            <span class="tech-icon">${item.icon}</span>
                            <div class="tech-details">
                                <div class="tech-name">${item.tech}</div>
                                <div class="tech-percentage">${item.usage}%</div>
                            </div>
                        </div>
                        <div class="tech-bar-container">
                            <div class="tech-bar" style="width: ${item.usage}%; background: ${item.color};"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // D3.js Charts
        function createBarChart(containerId, data, xKey, yKey, color = '#3b82f6') {
            if (!data || data.length === 0) {
                showPlaceholder(containerId);
                return;
            }
            const container = d3.select(`#${containerId}`);
            container.selectAll("*").remove();

            const margin = { top: 20, right: 30, bottom: 40, left: 80 };
            const width = 300 - margin.left - margin.right;
            const height = 400 - margin.bottom - margin.top;

            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => d[yKey])])
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d[xKey]))
                .range([0, height])
                .padding(0.1);

            g.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", 0)
                .attr("y", d => y(d[xKey]))
                .attr("width", d => x(d[yKey]))
                .attr("height", y.bandwidth())
                .attr("fill", color)
                .attr("rx", 4);

            g.selectAll(".label")
                .data(data)
                .enter().append("text")
                .attr("class", "label")
                .attr("x", d => x(d[yKey]) + 5)
                .attr("y", d => y(d[xKey]) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .style("font-size", "12px")
                .style("fill", "#374151")
                .text(d => d[yKey]);

            g.append("g")
                .call(d3.axisLeft(y))
                .style("font-size", "10px");
        }

        function createPieChart(containerId, data, categoryKey, valueKey) {
            if (!data || data.length === 0) {
                showPlaceholder(containerId);
                return;
            }
            const container = d3.select(`#${containerId}`);
            container.selectAll("*").remove();

            const width = 350;
            const pieHeight = 280;
            const legendHeight = 120;
            const height = pieHeight + legendHeight;
            const margin = 20;
            const radius = Math.min(width, pieHeight) / 2 - margin;

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            const g = svg.append("g")
                .attr("transform", `translate(${width/2}, ${pieHeight/2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d[categoryKey]))
                .range(['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#98d8c8', '#f7dc6f', '#ffaaa5']);

            const pie = d3.pie()
                .value(d => d[valueKey])
                .sort(null);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const labelArc = d3.arc()
                .outerRadius(radius - 10)
                .innerRadius(radius - 10);

            const arcs = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .style("fill", d => color(d.data[categoryKey]))
                .style("stroke", "white")
                .style("stroke-width", "2px");

            arcs.append("text")
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("dy", "0.35em")
                .style("text-anchor", "middle")
                .style("font-size", "10px")
                .style("font-weight", "500")
                .text(d => d.data.count > 50 ? d.data[categoryKey] : '');

            // Legend at bottom
            const legendData = color.domain();
            const itemsPerRow = 2;
            const legendStartY = pieHeight + 20;
            
            const legend = svg.selectAll(".legend")
                .data(legendData)
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => {
                    const row = Math.floor(i / itemsPerRow);
                    const col = i % itemsPerRow;
                    const x = 20 + col * 140;
                    const y = legendStartY + row * 18;
                    return `translate(${x}, ${y})`;
                });

            legend.append("rect")
                .attr("x", 0)
                .attr("width", 12)
                .attr("height", 12)
                .style("fill", color)
                .attr("rx", 2);

            legend.append("text")
                .attr("x", 18)
                .attr("y", 6)
                .attr("dy", "0.35em")
                .style("font-size", "10px")
                .text(d => d);
        }

        function createHeatmap(containerId, data) {
            if (!data || data.length === 0) {
                showPlaceholder(containerId);
                return;
            }
            const container = d3.select(`#${containerId}`);
            container.selectAll("*").remove();

            const margin = { top: 50, right: 30, bottom: 60, left: 100 };
            const width = 280 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const models = [...new Set(data.map(d => d.model))];
            const languages = [...new Set(data.map(d => d.language))];

            const x = d3.scaleBand()
                .domain(languages)
                .range([0, width])
                .padding(0.05);

            const y = d3.scaleBand()
                .domain(models)
                .range([height, 0])
                .padding(0.05);

            const colorScale = d3.scaleSequential(d3.interpolateBlues)
                .domain([80, 100]);

            g.selectAll(".cell")
                .data(data)
                .enter().append("rect")
                .attr("class", "cell")
                .attr("x", d => x(d.language))
                .attr("y", d => y(d.model))
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .attr("fill", d => colorScale(d.success))
                .attr("rx", 4);

            g.selectAll(".cell-text")
                .data(data)
                .enter().append("text")
                .attr("class", "cell-text")
                .attr("x", d => x(d.language) + x.bandwidth() / 2)
                .attr("y", d => y(d.model) + y.bandwidth() / 2)
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .style("font-size", "10px")
                .style("fill", "white")
                .style("font-weight", "bold")
                .text(d => `${d.success}%`);

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .style("font-size", "10px");

            g.append("g")
                .call(d3.axisLeft(y))
                .style("font-size", "10px");
        }

        // Animate big numbers
        function animateNumber(elementId, finalValue, duration = 2000) {
            const element = document.getElementById(elementId);
            const startValue = 0;
            const increment = finalValue / (duration / 16);
            let currentValue = startValue;

            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= finalValue) {
                    currentValue = finalValue;
                    clearInterval(timer);
                }
                // Format number with commas
                const formattedNumber = Math.floor(currentValue).toLocaleString('en-US');
                element.textContent = formattedNumber;
            }, 16);
        }

        // Load leaderboards data (demo or live)
        async function loadLeaderboards() {
            let leaderboardData;
            
            if (useDemoData) {
                // Load demo data from JSON file
                console.log('📊 Loading demo data from JSON...');
                leaderboardData = await loadDemoData();
                if (!leaderboardData) {
                    console.error('Failed to load demo data');
                    return;
                }
            } else {
                // Load live data from database API
                console.log('🔴 Loading live data from database...');
                
                // Start with empty structure
                leaderboardData = {
                    topAnalyzersOverall: [],
                    topAnalyzersAigallery: [],
                    successfulBuilders: [],
                    templatesWithIssues: [],
                    prevalentIssues: [],
                    activeTemplates: [],
                    healthyPython: [],
                    healthyJS: [],
                    successfulModels: [],
                    modelLanguageSuccess: [],
                    successfulAzdDeployments: [],
                    msftTechUsage: [],
                    globalStats: {
                        totalTemplatesAnalyzed: 0,
                        templatesCreatedWithMCP: 0,
                        totalInstallsAcrossMicrosoft: 0
                    }
                };
                
                try {
                    // Get OAuth token for authenticated API requests
                    const token = localStorage.getItem('gh_access_token');
                    const headers = {
                        'Content-Type': 'application/json',
                        ...(token && { Authorization: `Bearer ${token}` }),
                    };
                    
                    // Fetch the sections that ARE implemented in the API
                    const [mostIssues, prevalentIssues, activeTemplates, globalStats] = await Promise.all([
                        fetch('/api/v4/leaderboards/most-issues?limit=10', { headers }).then(r => r.ok ? r.json() : null),
                        fetch('/api/v4/leaderboards/prevalent-issues?limit=8', { headers }).then(r => r.ok ? r.json() : null),
                        fetch('/api/v4/leaderboards/active-templates?limit=10', { headers }).then(r => r.ok ? r.json() : null),
                        fetch('/api/v4/leaderboards/global/stats', { headers }).then(r => r.ok ? r.json() : null)
                    ]);
                    
                    // Update with real data where available
                    if (mostIssues?.data && mostIssues.data.length > 0) {
                        leaderboardData.templatesWithIssues = mostIssues.data;
                        console.log('✅ Loaded real data: most-issues (' + mostIssues.data.length + ' items)');
                    } else {
                        console.log('⚠️ No data available: most-issues');
                    }
                    
                    if (prevalentIssues?.data && prevalentIssues.data.length > 0) {
                        leaderboardData.prevalentIssues = prevalentIssues.data;
                        console.log('✅ Loaded real data: prevalent-issues (' + prevalentIssues.data.length + ' items)');
                    } else {
                        console.log('⚠️ No data available: prevalent-issues');
                    }
                    
                    if (activeTemplates?.data && activeTemplates.data.length > 0) {
                        leaderboardData.activeTemplates = activeTemplates.data;
                        console.log('✅ Loaded real data: active-templates (' + activeTemplates.data.length + ' items)');
                    } else {
                        console.log('⚠️ No data available: active-templates');
                    }
                    
                    if (globalStats) {
                        leaderboardData.globalStats = {
                            totalTemplatesAnalyzed: globalStats.totalTemplatesAnalyzed || 0,
                            templatesCreatedWithMCP: globalStats.templatesCreatedWithMCP || 0,
                            totalInstallsAcrossMicrosoft: globalStats.totalInstalls || 0
                        };
                        console.log('✅ Loaded global stats:', leaderboardData.globalStats);
                    }
                    
                    console.log('ℹ️ Not yet implemented (will show placeholders): top-analyzers, successful-builders, healthiest-templates, models, azd-deployments, tech-usage');
                    
                } catch (error) {
                    console.error('❌ Error loading live data:', error);
                }
            }
            
            // Clear existing content
            document.querySelectorAll('.chart-container > div[id]').forEach(el => {
                el.innerHTML = '';
            });
            
            // Add badges to indicate data source
            function addDataSourceBadge(containerId, isRealData) {
                const container = document.getElementById(containerId)?.parentElement;
                if (!container) return;
                
                // Remove existing badge
                const existingBadge = container.querySelector('.data-source-badge');
                if (existingBadge) existingBadge.remove();
                
                if (!useDemoData && isRealData) {
                    const badge = document.createElement('span');
                    badge.className = 'data-source-badge';
                    badge.innerHTML = '<i class="fas fa-database"></i> Live';
                    badge.style.cssText = 'display: inline-block; margin-left: 8px; padding: 3px 8px; background: #10b981; color: white; border-radius: 4px; font-size: 11px; font-weight: 600;';
                    const title = container.querySelector('.chart-title');
                    if (title) title.appendChild(badge);
                }
            }
            
            // Leaderboards (all demo for now - Phase 2)
            renderLeaderboard('top-analyzers-overall', leaderboardData.topAnalyzersOverall, 'analyses', 'collections');
            renderLeaderboard('top-analyzers-aigallery', leaderboardData.topAnalyzersAigallery, 'analyses', 'score');
            renderLeaderboard('successful-builders', leaderboardData.successfulBuilders, 'templates', 'successRate');

            // Issue lists
            renderIssuesList('most-issues', leaderboardData.templatesWithIssues);
            addDataSourceBadge('most-issues', !useDemoData);

            // Template lists
            renderTemplatesList('active-templates', leaderboardData.activeTemplates);
            addDataSourceBadge('active-templates', !useDemoData);
            
            renderTemplatesList('healthy-python', leaderboardData.healthyPython, true);
            renderTemplatesList('healthy-js', leaderboardData.healthyJS, true);
            renderAzdDeploymentsList('successful-azd-deployments', leaderboardData.successfulAzdDeployments);
            renderMsftTechUsage('msft-tech-usage', leaderboardData.msftTechUsage);

            // D3 Charts
            createPieChart('prevalent-issues', leaderboardData.prevalentIssues, 'category', 'count');
            addDataSourceBadge('prevalent-issues', !useDemoData);
            
            createBarChart('successful-models', leaderboardData.successfulModels, 'model', 'success', '#10b981');
            createHeatmap('model-language-success', leaderboardData.modelLanguageSuccess);

            // Animate big statistics with delay for visual impact
            setTimeout(() => {
                animateNumber('templates-mcp', leaderboardData.globalStats.templatesCreatedWithMCP, 2500);
                animateNumber('total-installs', leaderboardData.globalStats.totalInstallsAcrossMicrosoft, 3000);
                animateNumber('templates-analyzed', leaderboardData.globalStats.totalTemplatesAnalyzed, 2000);
            }, 500);
        }

        // Initialize all charts and lists
        document.addEventListener('DOMContentLoaded', function() {
            loadLeaderboards();
        });

        // Toggle navigation menu on mobile
        function toggleNav() {
            const nav = document.getElementById('main-nav');
            if (nav) {
                nav.classList.toggle('open');
            }
        }
    </script>

    <!-- Footer -->
    <footer class="site-footer" style="background: #1e293b; color: #cbd5e1; padding: 30px 0; margin-top: 60px;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <div style="margin-bottom: 10px;">©2025 - CoreAI Microsoft</div>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <a href="https://aka.ms/ai-gallery/submit" target="_blank" style="color: #94a3b8; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#94a3b8'">
                    <i class="fas fa-plus-circle"></i> Submit new template to gallery
                </a>
                <a href="https://github.com/Azure-Samples/azd-template-artifacts" target="_blank" style="color: #94a3b8; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#94a3b8'">
                    <i class="fas fa-check-square"></i> Definition of Done
                </a>
            </div>
        </div>
    </footer>
</body>
</html>
